<%- include('../layouts/userHeader.ejs') %>


    <style>
        #popup-window {
            position: fixed;
            width: 750px;
            height: 620px;
            border-radius: 20px;
            background: white;
            border: 1px solid black;
            padding: 10px;
            margin: auto;
            top: 0px;
            right: 100px;
            bottom: 0;
            left: 100px;
            z-index: 10;
            overflow: auto;
            display: none;
        }
    </style>




    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div>
        <section class="mt- mb-50">
            <div class="container">
                <!-- <div class="row">
                    <div class="col-lg-6 mb-sm-15">
                        <div class="toggle_info">
                            <span><i class="fi-rs-user mr-10"></i><span class="text-muted">Already have an
                                    account?</span> <a href="#loginform" data-bs-toggle="collapse" class="collapsed"
                                    aria-expanded="false">Click here to login</a></span>
                        </div>
                        <div class="panel-collapse collapse login_form" id="loginform">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have shopped with us before, please enter your details
                                    below. If you are a new customer, please proceed to the Billing &amp; Shipping
                                    section.</p>
                                <form method="post">
                                    <div class="form-group">
                                        <input type="text" name="email" placeholder="Username Or Email">
                                    </div>
                                    <div class="form-group">
                                        <input type="password" name="password" placeholder="Password">
                                    </div>
                                    <div class="login_footer form-group">
                                        <div class="chek-form">
                                            <div class="custome-checkbox">
                                                <input class="form-check-input" type="checkbox" name="checkbox"
                                                    id="remember" value="">
                                                <label class="form-check-label" for="remember"><span>Remember
                                                        me</span></label>
                                            </div>
                                        </div>
                                        <a href="#">Forgot password?</a>
                                    </div>
                                    <div class="form-group">
                                        <button class="btn btn-md" name="login">Log in</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="toggle_info">
                            <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span> <a
                                    href="#coupon" data-bs-toggle="collapse" class="collapsed"
                                    aria-expanded="false">Click here to enter your code</a></span>
                        </div>
                        <div class="panel-collapse collapse coupon_form " id="coupon">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                                <form method="post">
                                    <div class="form-group">
                                        <input type="text" placeholder="Enter Coupon Code...">
                                    </div>
                                    <div class="form-group">
                                        <button class="btn  btn-md" name="login">Apply Coupon</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div> -->
                <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-25">
                            <h4>DELIVERY ADDRESS</h4>
                        </div>
                        <% if(useraddress.length> 0) { %>
                            <div class="address-selection">
                                <% for(let i=0; i<useraddress.length; i++) { %>
                                    <!-- Address 1 -->
                                    <div class="address"
                                        style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <div style="margin-right: 5px;">
                                            <input type="radio" id="address<%= i %>" name="deliveryAddress"
                                                value="<%= useraddress[i]._id %>" style="transform: scale(0.9);"
                                                onclick="addressHandle('<%= cartItems._id %>')">
                                        </div>

                                        <div class="col-lg-12" style="margin-right: 50px;">
                                            <div class="card mb-3 mb-lg-0">
                                                <div class="card-header"
                                                    style="display: flex; justify-content: space-between;">
                                                    <h5 class="mb-0">Address</h5>
                                                    <a href="/addressEdit/<%= useraddress[i]._id %>" class="btn-small"
                                                        style="font-weight: bold; color: blue;">Edit</a>

                                                </div>

                                                <div class="card-body">
                                                    <address>
                                                        <%= useraddress[i].name %>,<%= useraddress[i].addressType %>
                                                                Address,<%= useraddress[i].mobile %><br>
                                                                    <%= useraddress[i].address %>,<%=
                                                                            useraddress[i].locality %>,<%=
                                                                                useraddress[i].district %>,<%=
                                                                                    useraddress[i].state %>,<%=
                                                                                        useraddress[i].pincode %>
                                                    </address>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>
                            </div>
                            <% } else { %>
                                <tr>
                                    <td colspan="6">Address Not Found</td>
                                </tr>
                                <% } %>

                                    <div class="col-md-6">
                                        <div class="mb-25">
                                            <h4>Billing Details</h4>
                                        </div>
                                        <div class="add-address" style="margin-bottom: 20px;">
                                            <a href="#" id="add-address-link" style="font-weight: bold;">Add Address</a>
                                        </div>
                                        <form id="address-form" action="/shipAddress" method="POST"
                                            onsubmit="return validateForm()" style="display: none;">
                                            <label for="name"
                                                style="display: block; margin-bottom: 5px;">Name<span>*</span></label>
                                            <input type="text" id="name" name="name"
                                                style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                                required>
                                            <div class="name-message" id="name-error"></div>

                                            <label for="mobile"
                                                style="display: block; margin-bottom: 5px;">Mobile<span>*</span></label>
                                            <input type="tel" id="mobile" name="mobile"
                                                style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                                required>
                                            <div class="mobile-message" id="mobile-error"></div>

                                            <label for="pincode"
                                                style="display: block; margin-bottom: 5px;">Pincode<span>*</span></label>
                                            <input type="text" id="pincode" name="pincode"
                                                style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                                required>
                                            <div class="pincode-message" id="pincode-error"></div>

                                            <label for="locality"
                                                style="display: block; margin-bottom: 5px;">Locality<span>*</span></label>
                                            <input type="text" id="locality" name="locality"
                                                style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                                required>
                                            <div class="locality-message" id="locality-error"></div>

                                            <label for="address"
                                                style="display: block; margin-bottom: 5px;">Address<span>*</span></label>
                                            <textarea id="address" name="address"
                                                style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                                required></textarea>
                                            <div class="address-message" id="address-error"></div>

                                            <label for="city"
                                                style="display: block; margin-bottom: 5px;">District<span>*</span></label>
                                            <input type="text" id="district" name="district"
                                                style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                                required>
                                            <div class="district-message" id="district-error"></div>

                                            <label for="state"
                                                style="display: block; margin-bottom: 5px;">State<span>*</span></label>
                                            <input type="text" id="state" name="state"
                                                style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                                required>
                                            <div class="state-message" id="state-error"></div>

                                            <fieldset style="margin-bottom: 15px;">
                                                <legend style="font-size: 14px;">Address Type<span>*</span></legend>
                                                <label style="font-size: 14px;"><input type="radio" name="addressType"
                                                        value="Home"
                                                        style="width: 12px; height: 12px; margin-right: 5px;">
                                                    Home</label>
                                                <label style="font-size: 14px;"><input type="radio" name="addressType"
                                                        value="Work"
                                                        style="width: 12px; height: 12px; margin-right: 5px;">
                                                    Work</label>
                                            </fieldset>



                                            <div style="text-align: center;">
                                                <button type="submit" class="btn"
                                                    style="background-color: #007bff; color: #fff; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; text-align: center; text-decoration: none; font-size: 16px;">Submit</button>
                                                <button type="button" class="btn"
                                                    style="background-color: #dc3545; color: #fff; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; text-align: center; text-decoration: none; font-size: 16px; margin-left: 10px;">Cancel</button>
                                            </div>
                                        </form>
                                    </div>

                    </div>
                    <div class="col-md-6">
                        <% if (cartItems && cartItems.products && cartItems.products.length> 0 && coupons) { %>
                            <div class="order_review">
                                <div class="mb-20">
                                    <h4 style="text-align: center;">Your Orders</h4>
                                </div>
                                <div class="table-responsive order_table text-center">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th colspan="2">Product</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% cartItems.products.forEach((product,index)=> { %>
                                                <tr>
                                                    <td class="image product-thumbnail"><img
                                                            src="/productImages/<%= product.product.image[0] %>"
                                                            alt="Item" style="max-width: 50px; max-height: 50px;"></td>
                                                    <td>
                                                        <h5 style="margin-bottom: 4px;"><a href="#">
                                                                <%= product.product.productname %>
                                                            </a></h5>
                                                        <div class="detail-qtyy border radius m-auto"
                                                            style="display: flex; justify-content: space-between;">
                                                            <!-- Decrease quantity -->
                                                            <div>
                                                                <a type="submit"
                                                                    onclick="updateQuantity('<%= product.product._id %>', 'decrement' , '<%= index %>')"
                                                                    style="cursor: pointer; font-size: 20px;"><i
                                                                        class="fi-rs-angle-small-down"></i></a>
                                                            </div>

                                                            <!-- Quantity display -->
                                                            <div>
                                                                <span id="quantity-<%= product.product._id %>"
                                                                    class="qty-val"
                                                                    style="font-size: 14px; margin-left: 10px; margin-right: 10px;">
                                                                    <%= product.quantity %>
                                                                </span>
                                                            </div>

                                                            <!-- Increase quantity -->
                                                            <div>
                                                                <a type="submit"
                                                                    onclick="updateQuantity('<%= product.product._id %>', 'increment', '<%= index %>')"
                                                                    style="cursor: pointer; font-size: 20px;"><i
                                                                        class="fi-rs-angle-small-up"></i></a>
                                                            </div>
                                                        </div>

                                                        <!-- <div style="margin-top: 3px;">
                                                            <button style="background:none; border: none; font-weight: bold;">REMOVE</button>
                                                        </div> -->

                                                    </td>
                                                    <td id="subtotal-<%= product.product._id %>"
                                                        class="product-subtotal" colspan="2">â‚¹<%= product.subtotal %>
                                                    </td>
                                                </tr>
                                                <% }) %>

                                                    <tr>
                                                        <th>SubTotal</th>
                                                        <td id="checkout-subtotal" class="product-subtotal" colspan="2">
                                                            â‚¹<%= cartItems.total %>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th>Shipping</th>
                                                        <td id="shippingAmount" colspan="2">No shipping charge</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Discount</th>
                                                        <td id="couponAmount" colspan="2">No coupon</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Total</th>
                                                        <td id="checkout-total" colspan="2" class="product-subtotal">
                                                            <span class="font-xl text-brand fw-900">â‚¹<%= cartItems.total
                                                                    %></span>
                                                        </td>
                                                    </tr>

                                        </tbody>
                                    </table>
                                </div>
                                <div>
                                    <a href="#" id="popup-link" onmouseover="this.style.color='red';"
                                        onmouseout="this.style.color='black';">Click for Applicable Coupons</a>
                                    <p id="is_Applied" style="display: none;">Coupon Applied</p>
                                    <p style="color: red;" id="error-message"></p>
                                    <div id="couponCode" class="input-group" style="margin-top: 5px;">
                                        <input type="text" class="form-control" id="enteredCoupon" name="couponId"
                                            placeholder="Enter coupon ID" required>
                                        <input type="text" class="form-control"
                                            style="display: none; color: rgb(255, 115, 0);" id="appliedCoupon"
                                            name="couponId" required>
                                        <button type="button" id="couponApplied" onclick="couponApply()"
                                            class="btn btn-secondary" style="margin-left: 10px;">Apply</button>
                                        <button type="button" id="couponRemoved" onclick="removeCoupon()"
                                            class="btn btn-secondary"
                                            style="margin-left: 10px; display: none;">Remove</button>
                                    </div>
                                </div>


                                <div id="popup-window">
                                    <div style="padding-left: 10px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <div>
                                                <h5 class="mb-0" style=" color: black;">Available Coupons</h5>
                                            </div>
                                            <div>
                                                <span type="button" onclick="closePopup()"
                                                style='font-size:10px;'>&#10060;</span>
                                            </div>
                                        </div>
                                        <div>
                                            <div
                                                style="display: flexbox; width: 700px; border-style: solid; border-width: 0.5px; border-color: black;">
                                                <% if (coupons && coupons.length> 0) { %>
                                                    <% coupons.forEach(function(coupon) { %>
                                                        <div class="col-md-12 mb-12">
                                                            <div
                                                                style="background-color: rgb(255, 255, 255); padding: 10px; border-radius: 5px;">
                                                                <div>
                                                                    <div style="display: flex;">
                                                                        <p
                                                                            style="margin-left: 0px; font-size: medium; font-weight: bold; color: rgb(1, 119, 1);">
                                                                            <%= coupon.description %>
                                                                        </p>
                                                                        <p style="margin-left: 400px;">Valid till <%=
                                                                                coupon.expireDate %>
                                                                        </p>
                                                                    </div>
                                                                    <div>
                                                                        <p>Get extra <%= coupon.maximumDiscount %>
                                                                        </p>
                                                                        <p>Spend a minimum of <%= coupon.minimumAmount
                                                                                %> to
                                                                                use this coupon.</p>
                                                                        <div style="display: flex;">
                                                                            <p>You can use this coupon for purchases up
                                                                                to
                                                                                <%= coupon.maximumAmount %> max.
                                                                            </p>
                                                                            <div style="margin-left: auto;">
                                                                                <p
                                                                                    style="color: rgb(255, 153, 0); font-weight: bold;">
                                                                                    Coupon code: <%= coupon.couponId %>
                                                                                </p>
                                                                            </div>
                                                                            <div>
                                                                                <button class="btn btn-secondary"
                                                                                    id="close-button"
                                                                                    style="padding: 0.125rem 0.25rem; font-size: 0.575rem; margin-left: 4px; margin-top: 3px;"
                                                                                    onclick="copyCoupon('<%= coupon.couponId %>')">Copy</button>
                                                                            </div>
                                                                        </div>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div
                                                            style="margin-top: 3px; border-top: 1px solid black; width: 100%;">
                                                        </div>
                                                        <% }); %>
                                                            <% } else { %>
                                                                <div class="col-md-12">
                                                                    <p>No more coupons available right now. Keep in
                                                                        touch
                                                                        with us!</p>
                                                                </div>
                                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                    <button type="submit" onclick="closePopup()" id="close-button"
                                        class="btn btn-secondary">Close</button>
                                </div>

                                <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                                <div class="payment_method">
                                    <div class="mb-25">
                                        <h5>Payment</h5>
                                    </div>
                                    <% if (cartItems.total <=1000) { %>
                                        <div class="payment_option">
                                            <div id="COD" class="custome-radio">
                                                <input class="form-check-input" required="" type="radio"
                                                    name="payment_option" id="Cash On Delivery" checked="">
                                                <label class="form-check-label" for="Cash On Delivery"
                                                    data-bs-toggle="collapse" data-target="#bankTranfer"
                                                    aria-controls="bankTranfer">Cash on Delivery</label>
                                            </div>
                                        </div>
                                        <% } else { %>
                                            <div class="payment_option">
                                                <div id="COD" class="custome-radio">
                                                    <input class="form-check-input" required="" type="radio"
                                                        name="payment_option" id="Cash On Delivery" checked="" disabled>
                                                    <label class="form-check-label" for="Cash On Delivery"
                                                        data-bs-toggle="collapse" data-target="#bankTranfer"
                                                        aria-controls="bankTranfer">Cash on Delivery (Not available for
                                                        orders over 1000)</label>
                                                </div>
                                            </div>
                                            <% } %>

                                                <div class="custome-radio">
                                                    <input class="form-check-input" required="" type="radio"
                                                        name="payment_option" id="Razorpay" checked="">
                                                    <label class="form-check-label" for="Razorpay"
                                                        data-bs-toggle="collapse" data-target="#Razorpay"
                                                        aria-controls="Razorpay">Razorpay</label>
                                                </div>
                                </div>

                            </div>
                    </div>
                    <% } else { %>
                        <tr>
                            <td colspan="6">No products in cart</td>
                        </tr>
                        <% } %>
                </div>
            </div>
            <% if (cartItems.products.length> 0 ) { %>
                <button class="btn btn-fill-out btn-block mt-30" style="margin-left: 950px;"
                    onclick="placeOrder('<%= cartItems._id %>')">Place Order</button>
                <% } else { %>
                    <button class="btn btn-fill-out btn-block mt-30" style="margin-left: 950px;"
                        onclick="placeOrder('<%= cartItems._id %>')" disabled>Place Order</button>
                    <% } %>
        </section>
    </main>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <script>
        if (document.getElementById('checkout-total').value > 1000) {
            document.getElementById("COD").readOnly = true;
        }
    </script>



    <script>
        var popupLink = document.getElementById("popup-link");
        var popupWindow = document.getElementById("popup-window");
        var closeButton = document.getElementById("close-button");
        popupLink.addEventListener("click", function (event) {
            event.preventDefault();
            popupWindow.style.display = "block";
        });
        function closePopup() {
            popupWindow.style.display = "none";
        };
    </script>

    <script>
        function copyCoupon(couponId) {
            var tempInput = document.createElement('input');
            tempInput.value = couponId;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            swal({
                title: "Yah",
                text: "Coupon Copied",
                icon: "success",
                timer: 1500,
                buttons: false
            })

        }
    </script>

    <script>

        async function couponApply() {

            const couponId = document.getElementById('enteredCoupon').value
            const couponApplied = document.getElementById('couponApplied');
            const popupLink = document.getElementById('popup-link');
            const couponCode = document.getElementById('couponCode');
            const couponRemoved = document.getElementById('couponRemoved');
            const is_Applied = document.getElementById('is_Applied');
            const enteredCoupon = document.getElementById('enteredCoupon');
            const appliedCoupon = document.getElementById('appliedCoupon');
            const response = await fetch(`/couponApply/${couponId}`, {
                method: 'get'
            })
            const data = await response.json();
            if (response.ok) {
                swal({
                    title: "Wow ðŸ˜Š",
                    text: "Coupon Applied",
                    icon: "success",
                    timer: 1500,
                    buttons: false
                });

                couponApplied.style.display = 'none';
                popupLink.style.display = 'none';
                enteredCoupon.style.display = 'none';
                couponRemoved.style.display = 'block';
                is_Applied.style.display = 'block';
                enteredCoupon.style.display = 'none';
                appliedCoupon.style.display = 'block';
                appliedCoupon.value = couponId;
                document.getElementById('couponAmount').innerText = data.success;
                document.getElementById('checkout-total').innerText = "â‚¹" + data.newTotal
                document.getElementById("appliedCoupon").readOnly = true;
            } else {
                document.getElementById('error-message').innerText = data.error;
            }
            removeInnerText();
            function removeInnerText() {
                const message = document.getElementById('error-message');
                setTimeout(() => {
                    message.innerText = '';
                }, 2000);
                document.getElementById('enteredCoupon').value = '';
            }
        }

        async function removeCoupon() {
            const couponId = document.getElementById('appliedCoupon').value
            const couponApplied = document.getElementById('couponApplied');
            const popupLink = document.getElementById('popup-link');
            const couponCode = document.getElementById('couponCode');
            const couponRemoved = document.getElementById('couponRemoved');
            const is_Applied = document.getElementById('is_Applied');
            const enteredCoupon = document.getElementById('enteredCoupon');
            const appliedCoupon = document.getElementById('appliedCoupon');

            const response = await fetch(`/couponRemove/${couponId}`, {
                method: 'get'
            })
            const data = await response.json();
            if (response.ok) {
                swal({
                    title: "Coupon Removed ðŸ˜¢",
                    text: "The coupon has been successfully removed.",
                    icon: "success",
                    timer: 2000,
                    buttons: false
                });

                couponRemoved.style.display = 'none';
                is_Applied.style.display = 'none';
                enteredCoupon.style.display = 'block';
                couponApplied.style.display = 'block';
                popupLink.style.display = 'block';
                enteredCoupon.style.display = 'block';
                appliedCoupon.style.display = 'none';
                document.getElementById('couponAmount').innerText = data.success;
                document.getElementById('checkout-total').innerText = "â‚¹" + data.newTotal
                document.getElementById('enteredCoupon').value = '';
            }
        }
    </script>



    <script>
        function validateForm() {
            var name = document.getElementById('name').value.trim();
            var mobile = document.getElementById('mobile').value.trim();
            var pincode = document.getElementById('pincode').value.trim();
            var locality = document.getElementById('locality').value.trim();
            var address = document.getElementById('address').value.trim();
            var district = document.getElementById('district').value.trim();
            var state = document.getElementById('state').value.trim();
            var addressType = document.querySelector('input[name="addressType"]:checked');

            var isValid = true;

            // Reset error messages
            document.querySelectorAll('.error-message').forEach(function (element) {
                element.innerText = '';
            });

            // Validate name
            var namePattern = /^[A-Za-z\s]+$/;
            if (name === '') {
                document.getElementById('name-error').innerText = 'Name is required';
                isValid = false;
            } else if (!namePattern.test(name)) {
                document.getElementById('name-error').innerText = 'Name can only contain alphabetic characters';
                isValid = false;
            }


            // Validate mobile
            var mobilePattern = /^(?!0)(?!(\d)\1{3})\d{10}$/;
            if (mobile === '') {
                document.getElementById('mobile-error').innerText = 'Mobile is required';
                isValid = false;
            } else if (!mobilePattern.test(mobile)) {
                document.getElementById('mobile-error').innerText = 'Enter a valid 10-digit mobile number';
                isValid = false;
            }

            // Validate pincode
            var pincodePattern = /^[1-9][0-9]{2}\s?[0-9]{3}$/;
            if (pincode === '') {
                document.getElementById('pincode-error').innerText = 'Pincode is required';
                isValid = false;
            } else if (!pincodePattern.test(pincode)) {
                document.getElementById('pincode-error').innerText = 'Enter a valid pincode';
                isValid = false;
            }

            // Validate locality
            var localityPattern = /^[A-Za-z\s]+$/;
            if (locality === '') {
                document.getElementById('locality-error').innerText = 'Locality is required';
                isValid = false;
            } else if (!localityPattern.test(locality)) {
                document.getElementById('locality-error').innerText = 'Locality can only contain alphabetic characters';
                isValid = false;
            }

            // Validate address
            var addressPattern = /^[A-Za-z0-9\s]+$/;
            if (address === '') {
                document.getElementById('address-error').innerText = 'Address is required';
                isValid = false;
            } else if (!addressPattern.test(address)) {
                document.getElementById('address-error').innerText = 'Enter a valid address';
                isValid = false;
            }

            // Validate district
            var districtPattern = /^[A-Za-z\s]+$/;
            if (district === '') {
                document.getElementById('district-error').innerText = 'District is required';
                isValid = false;
            } else if (!districtPattern.test(district)) {
                document.getElementById('district-error').innerText = 'District can only contain alphabetic characters';
                isValid = false;
            }

            // Validate state
            var statePattern = /^[A-Za-z\s]+$/;
            if (state === '') {
                document.getElementById('state-error').innerText = 'State is required';
                isValid = false;
            } else if (!statePattern.test(state)) {
                document.getElementById('state-error').innerText = 'State can only contain alphabetic characters';
                isValid = false;
            }

            // Validate address type
            if (!addressType) {
                document.getElementById('addressType-error').innerText = 'Please select an address type';
                isValid = false;
            }

            return isValid;
        }
    </script>

    <script>
        // Get references to the link and the form
        const addAddressLink = document.getElementById('add-address-link');
        const addressForm = document.getElementById('address-form');

        // Add event listener to the link
        addAddressLink.addEventListener('click', function (event) {
            event.preventDefault(); // Prevent default link behavior
            if (addressForm.style.display === 'none') {
                addressForm.style.display = 'block'; // Display the form
            } else {
                addressForm.style.display = 'none'; // Hide the form
            }
        });
    </script>

    <script>
        async function updateQuantity(productId, action, index) {
            try {
                const response = await fetch(`/update-quantity/${productId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: action, index: index })
                });

                const data = await response.json();


                if (response.status === 200) {
                    // Update the quantity display
                    document.getElementById(`quantity-${productId}`).innerText = data.currentCartitem.quantity;
                    // Update the subtotal display
                    document.getElementById(`subtotal-${productId}`).innerText = "â‚¹" + data.currentCartitem.subtotal;
                    // // Update the total display
                    document.getElementById('checkout-subtotal').innerText = "â‚¹" + data.Total;
                    // // Update the total display
                    document.getElementById('checkout-total').innerText = "â‚¹" + data.Total;
                } else if (response.status === 400) {

                    swal({
                        title: "Warning",
                        text: data.error,
                        icon: "warning",
                        timer: 1500,
                        buttons: false
                    });



                } else if (response.status === 404) {
                    swal("Error", "Resource not found", "error");
                } else if (response.status === 500) {
                    swal("Error", "Internal server error occurred", "error");
                } else {
                    swal("Error", "An error occurred", "error");
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
    </script>

    <script>
        let selectedAddressId;

        async function addressHandle(cartId) {
            // Find the selected address ID
            selectedAddressId = document.querySelector('input[name="deliveryAddress"]:checked').value;
            const response = await fetch(`/deliveryCharge?selectedAddressId=${selectedAddressId}&cartId=${cartId}`, {
                method: 'GET'
            });


            const data = await response.json();
            if (data) {
                let deliveryCharge = data.success;
                console.log(deliveryCharge)
                document.getElementById('shippingAmount').innerText = deliveryCharge;
            }
        }

        async function placeOrder(cartId) {
            try {
                let deliveryCharge = document.getElementById('shippingAmount').innerText
                if (deliveryCharge === "No Shipping charge") {
                    deliveryCharge = 0;
                    console.log(deliveryCharge);
                }
                console.log(deliveryCharge);
                let couponId = document.getElementById('appliedCoupon').value
                let selectedPaymentOption = document.querySelector('input[name="payment_option"]:checked').id;

                const response = await fetch('/placeorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cartId: cartId, couponId: couponId, addressId: selectedAddressId, paymentOption: selectedPaymentOption, deliveryCharge: deliveryCharge })
                });

                const data = await response.json();
                if (data.error) {
                    swal({
                        title: "Alert",
                        text: "Choose any address.",
                        icon: "warning",
                        button: "OK"
                    })
                }
                else if (data.cod_success) {
                    window.location.href = "/orderpage";
                } else {
                    console.log(data.razorpay);
                    razorpayPayment(data.razorpay, data.id, cartId, couponId, selectedAddressId, selectedPaymentOption);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function razorpayPayment(order, key_id, cartId, couponId, selectedAddressId, selectedPaymentOption) {
            if (order) {
                var options = {
                    "key": key_id,
                    "amount": (order.amount),
                    "currency": "INR",
                    "name": "LuxXWatch",
                    "description": "Test Transaction",
                    "image": "https://example.com/your_logo",
                    "order_id": order.id,
                    "handler": function (response) {
                        // alert(response.razorpay_payment_id);
                        // alert(response.razorpay_order_id);
                        // alert(response.razorpay_signature);
                        window.location.href = "/orderpage";
                        verifyPayment(response, order, cartId, couponId, selectedAddressId, selectedPaymentOption);
                    },
                    "prefill": {
                        "name": "Gaurav Kumar",
                        "email": "gaurav.kumar@example.com",
                        "contact": "9000090000"
                    },
                    "notes": {
                        "address": "Razorpay Corporate Office"
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };

                let paymentAttempted = false;

                var rzp1 = new Razorpay(options);

                rzp1.on('payment.failed', function (response) {
                    if (!paymentAttempted) {
                        paymentAttempted = true;
                        // Payment failed
                        swal({
                            title: "Payment Failed",
                            text: "Your payment was unsuccessful.",
                            icon: "error",
                            button: "OK"
                        }).then(() => {
                            window.location.href = "/profile"
                            console.error('Payment failed:', response.error);
                        });
                    }
                });

                rzp1.open();
            } else {
                console.error('Invalid order object or amount property is missing');
                return;
            }
        }



        async function verifyPayment(payment, order, cartId, couponId, selectedAddressId, selectedPaymentOption) {
            try {
                const response = await fetch('/verifyPayment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ payment, order, cartId, couponId, selectedAddressId, selectedPaymentOption })
                });
                if (response.razorpay_success) {
                    // Order placed successfully, redirect to order page

                }
            } catch (error) {
                console.error('Error verifying payment:', error);
            }
        }
    </script>



    <%- include('../layouts/userFooter.ejs') %>