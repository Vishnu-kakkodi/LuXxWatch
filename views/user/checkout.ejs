<%- include('../layouts/userHeader.ejs') %>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div>
        <section class="mt- mb-50">
            <div class="container">
                <!-- <div class="row">
                    <div class="col-lg-6 mb-sm-15">
                        <div class="toggle_info">
                            <span><i class="fi-rs-user mr-10"></i><span class="text-muted">Already have an
                                    account?</span> <a href="#loginform" data-bs-toggle="collapse" class="collapsed"
                                    aria-expanded="false">Click here to login</a></span>
                        </div>
                        <div class="panel-collapse collapse login_form" id="loginform">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have shopped with us before, please enter your details
                                    below. If you are a new customer, please proceed to the Billing &amp; Shipping
                                    section.</p>
                                <form method="post">
                                    <div class="form-group">
                                        <input type="text" name="email" placeholder="Username Or Email">
                                    </div>
                                    <div class="form-group">
                                        <input type="password" name="password" placeholder="Password">
                                    </div>
                                    <div class="login_footer form-group">
                                        <div class="chek-form">
                                            <div class="custome-checkbox">
                                                <input class="form-check-input" type="checkbox" name="checkbox"
                                                    id="remember" value="">
                                                <label class="form-check-label" for="remember"><span>Remember
                                                        me</span></label>
                                            </div>
                                        </div>
                                        <a href="#">Forgot password?</a>
                                    </div>
                                    <div class="form-group">
                                        <button class="btn btn-md" name="login">Log in</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="toggle_info">
                            <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span> <a
                                    href="#coupon" data-bs-toggle="collapse" class="collapsed"
                                    aria-expanded="false">Click here to enter your code</a></span>
                        </div>
                        <div class="panel-collapse collapse coupon_form " id="coupon">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                                <form method="post">
                                    <div class="form-group">
                                        <input type="text" placeholder="Enter Coupon Code...">
                                    </div>
                                    <div class="form-group">
                                        <button class="btn  btn-md" name="login">Apply Coupon</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div> -->
                <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-25">
                            <h4>DELIVERY ADDRESS</h4>
                        </div>
                        <% if(useraddress.length> 0) { %>
                            <div class="address-selection">
                                <% for(let i=0; i<useraddress.length; i++) { %>
                                    <!-- Address 1 -->
                                    <div class="address"
                                        style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <div style="margin-right: 5px;">
                                            <input type="radio" id="address<%= i %>" name="deliveryAddress" value="<%= useraddress[i]._id %>"
                                                style="transform: scale(0.9);" onclick="addressHandle()">
                                        </div>
                                        
                                        <div class="col-lg-12" style="margin-right: 50px;">
                                            <div class="card mb-3 mb-lg-0">
                                                <div class="card-header"
                                                    style="display: flex; justify-content: space-between;">
                                                    <h5 class="mb-0">Address</h5>
                                                    <a href="/addressEdit/<%= useraddress[i]._id %>" class="btn-small"
                                                        style="font-weight: bold; color: blue;">Edit</a>

                                                </div>

                                                <div class="card-body">
                                                    <address>
                                                        <%= useraddress[i].name %>,<%= useraddress[i].addressType %>
                                                                Address,<%= useraddress[i].mobile %><br>
                                                                    <%= useraddress[i].address %>,<%=
                                                                            useraddress[i].locality %>,<%=
                                                                                useraddress[i].district %>,<%=
                                                                                    useraddress[i].state %>,<%=
                                                                                        useraddress[i].pincode %>
                                                    </address>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>
                            </div>
                            <% } else { %>
                                <tr>
                                    <td colspan="6">Address Not Found</td>
                                </tr>
                                <% } %>

                                <div class="col-md-6">
                                    <div class="mb-25">
                                        <h4>Billing Details</h4>
                                    </div>
                                    <div class="add-address" style="margin-bottom: 20px;">
                                        <a href="#" id="add-address-link" style="font-weight: bold;">Add Address</a>
                                    </div>
                                    <form id="address-form" action="/shipAddress" method="POST" onsubmit="return validateForm()" style="display: none;">
                                        <label for="name" style="display: block; margin-bottom: 5px;">Name<span>*</span></label>
                                        <input type="text" id="name" name="name"
                                            style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                            required>
                                        <div class="name-message" id="name-error"></div>
                                         
                                        <label for="mobile" style="display: block; margin-bottom: 5px;">Mobile<span>*</span></label>
                                        <input type="tel" id="mobile" name="mobile"
                                            style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                            required>
                                        <div class="mobile-message" id="mobile-error"></div>
                        
                                        <label for="pincode" style="display: block; margin-bottom: 5px;">Pincode<span>*</span></label>
                                        <input type="text" id="pincode" name="pincode"
                                            style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                            required>
                                        <div class="pincode-message" id="pincode-error"></div>
                        
                                        <label for="locality" style="display: block; margin-bottom: 5px;">Locality<span>*</span></label>
                                        <input type="text" id="locality" name="locality"
                                            style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                            required>
                                        <div class="locality-message" id="locality-error"></div>
                        
                                        <label for="address" style="display: block; margin-bottom: 5px;">Address<span>*</span></label>
                                        <textarea id="address" name="address"
                                            style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                            required></textarea>
                                        <div class="address-message" id="address-error"></div>
                        
                                        <label for="city" style="display: block; margin-bottom: 5px;">District<span>*</span></label>
                                        <input type="text" id="district" name="district"
                                            style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                            required>
                                        <div class="district-message" id="district-error"></div>
                        
                                        <label for="state" style="display: block; margin-bottom: 5px;">State<span>*</span></label>
                                        <input type="text" id="state" name="state"
                                            style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"
                                            required>
                                        <div class="state-message" id="state-error"></div>
                        
                                        <fieldset style="margin-bottom: 15px;">
                                            <legend style="font-size: 14px;">Address Type<span>*</span></legend>
                                            <label style="font-size: 14px;"><input type="radio" name="addressType" value="Home"
                                                    style="width: 12px; height: 12px; margin-right: 5px;"> Home</label>
                                            <label style="font-size: 14px;"><input type="radio" name="addressType" value="Work"
                                                    style="width: 12px; height: 12px; margin-right: 5px;"> Work</label>
                                        </fieldset>
                        
                        
                        
                                        <div style="text-align: center;">
                                            <button type="submit" class="btn"
                                                style="background-color: #007bff; color: #fff; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; text-align: center; text-decoration: none; font-size: 16px;">Submit</button>
                                            <button type="button" class="btn"
                                                style="background-color: #dc3545; color: #fff; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; text-align: center; text-decoration: none; font-size: 16px; margin-left: 10px;">Cancel</button>
                                        </div>
                                    </form>
                                </div>

                    </div>
                    <div class="col-md-6">
                        <div class="order_review">
                            <div class="mb-20">
                                <h4>Your Orders</h4>
                            </div>
                            <div class="table-responsive order_table text-center">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>


                                        <% if (cartItems && cartItems.products && cartItems.products.length> 0) { %>
                                            <% cartItems.products.forEach(product=> { %>
                                                <tr>
                                                    <td class="image product-thumbnail"><img
                                                            src="/productImages/<%= product.product.image[0] %>"
                                                            alt="Item" style="max-width: 50px; max-height: 50px;"></td>
                                                    <td>
                                                        <h5 style="margin-bottom: 4px;"><a href="#">
                                                                <%= product.product.productname %>
                                                            </a></h5>
                                                        <div class="detail-qtyy border radius m-auto"
                                                            style="display: flex; justify-content: space-between; align-items: center;">
                                                            <!-- Decrease quantity -->
                                                            <button type="button"
                                                                onclick="updateQuantity('<%= product.product._id %>', 'decrement')"
                                                                style="cursor: pointer; font-size: 8px; max-height: fit-content; background-color: lightgray;"><i
                                                                    class="fas fa-minus">&#10134;</i></button>

                                                            <!-- Quantity display -->
                                                            <span id="quantity-<%= product.product._id %>"
                                                                class="qty-val"
                                                                style="font-size: 14px; margin-left: 10px; margin-right: 10px;">
                                                                <%= product.quantity %>
                                                            </span>

                                                            <!-- Increase quantity -->
                                                            <button type="button"
                                                                onclick="updateQuantity('<%= product.product._id %>', 'increment')"
                                                                style="cursor: pointer; font-size: 8px; max-height: fit-content;  background-color: lightgray;"><i
                                                                    class="fas fa-plus"></i>&#10133;</button>
                                                        </div>
                                                        <!-- <div style="margin-top: 3px;">
                                                            <button style="background:none; border: none; font-weight: bold;">REMOVE</button>
                                                        </div> -->

                                                    </td>
                                                    <td id="subtotal-<%= product.product._id %>"
                                                        class="product-subtotal" colspan="2">₹<%= product.subtotal %>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                                    
                                                            <tr>
                                                                <th>SubTotal</th>
                                                                <td id="checkout-subtotal" class="product-subtotal"
                                                                    colspan="2">₹<%= cartItems.total %>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <th>Shipping</th>
                                                                <td colspan="2"><em>Free Shipping</em></td>
                                                            </tr>
                                                            <tr>
                                                                <th>Total</th>
                                                                <td id="checkout-total" colspan="2"
                                                                    class="product-subtotal"><span
                                                                        class="font-xl text-brand fw-900">₹<%=
                                                                            cartItems.total %></span></td>
                                                            </tr>
                                                            <% } else { %>
                                                                <tr>
                                                                    <td colspan="6">No products in cart</td>
                                                                </tr>
                                                                <% } %>
                                    </tbody>
                                </table>
                            </div>
                            <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                            <div class="payment_method">
                                <div class="mb-25">
                                    <h5>Payment</h5>
                                </div>
                                <div class="payment_option">
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="Cash On Delivery" checked="">
                                        <label class="form-check-label" for="Cash On Delivery" data-bs-toggle="collapse" data-target="#bankTranfer" aria-controls="bankTranfer">Cash on Delivery</label>
                                    </div>
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="Paypal" checked="">
                                        <label class="form-check-label" for="Paypal" data-bs-toggle="collapse" data-target="#paypal" aria-controls="paypal">Paypal</label>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
                <% if (cartItems.products.length> 0 ) { %>
                <button  class="btn btn-fill-out btn-block mt-30" style="margin-left: 950px;" onclick="placeOrder('<%= cartItems._id %>')">Place Order</button>
                <% } else { %>
                <button  class="btn btn-fill-out btn-block mt-30" style="margin-left: 950px;" onclick="placeOrder('<%= cartItems._id %>')" disabled>Place Order</button>
                <% } %>
        </section>
    </main>


    <script>
        function validateForm() {
            var name = document.getElementById('name').value.trim();
            var mobile = document.getElementById('mobile').value.trim();
            var pincode = document.getElementById('pincode').value.trim();
            var locality = document.getElementById('locality').value.trim();
            var address = document.getElementById('address').value.trim();
            var district = document.getElementById('district').value.trim();
            var state = document.getElementById('state').value.trim();
            var addressType = document.querySelector('input[name="addressType"]:checked');
    
            var isValid = true;
    
            // Reset error messages
            document.querySelectorAll('.error-message').forEach(function (element) {
                element.innerText = '';
            });
    
            // Validate name
            var namePattern = /^[A-Za-z\s]+$/;
            if (name === '') {
                document.getElementById('name-error').innerText = 'Name is required';
                isValid = false;
            } else if (!namePattern.test(name)) {
                document.getElementById('name-error').innerText = 'Name can only contain alphabetic characters';
                isValid = false;
            }

    
            // Validate mobile
            var mobilePattern = /^(?!0)(?!(\d)\1{3})\d{10}$/;
            if (mobile === '') {
                document.getElementById('mobile-error').innerText = 'Mobile is required';
                isValid = false;
            } else if (!mobilePattern.test(mobile)) {
                document.getElementById('mobile-error').innerText = 'Enter a valid 10-digit mobile number';
                isValid = false;
            }
    
            // Validate pincode
            var pincodePattern = /^[1-9][0-9]{2}\s?[0-9]{3}$/;
            if (pincode === '') {
                document.getElementById('pincode-error').innerText = 'Pincode is required';
                isValid = false;
            } else if (!pincodePattern.test(pincode)) {
                document.getElementById('pincode-error').innerText = 'Enter a valid pincode';
                isValid = false;
            }
    
            // Validate locality
            var localityPattern = /^[A-Za-z\s]+$/;
            if (locality === '') {
                document.getElementById('locality-error').innerText = 'Locality is required';
                isValid = false;
            } else if (!localityPattern.test(locality)) {
                document.getElementById('locality-error').innerText = 'Locality can only contain alphabetic characters';
                isValid = false;
            }
    
            // Validate address
            var addressPattern = /^[A-Za-z0-9\s]+$/;
            if (address === '') {
                document.getElementById('address-error').innerText = 'Address is required';
                isValid = false;
            } else if (!addressPattern.test(address)) {
                document.getElementById('address-error').innerText = 'Enter a valid address';
                isValid = false;
            }
    
            // Validate district
            var districtPattern = /^[A-Za-z\s]+$/;
            if (district === '') {
                document.getElementById('district-error').innerText = 'District is required';
                isValid = false;
            } else if (!districtPattern.test(district)) {
                document.getElementById('district-error').innerText = 'District can only contain alphabetic characters';
                isValid = false;
            }
    
            // Validate state
            var statePattern = /^[A-Za-z\s]+$/;
            if (state === '') {
                document.getElementById('state-error').innerText = 'State is required';
                isValid = false;
            } else if (!statePattern.test(state)) {
                document.getElementById('state-error').innerText = 'State can only contain alphabetic characters';
                isValid = false;
            }
    
            // Validate address type
            if (!addressType) {
                document.getElementById('addressType-error').innerText = 'Please select an address type';
                isValid = false;
            }
    
            return isValid;
        }
    </script>

    <script>
    // Get references to the link and the form
    const addAddressLink = document.getElementById('add-address-link');
    const addressForm = document.getElementById('address-form');

    // Add event listener to the link
    addAddressLink.addEventListener('click', function(event) {
        event.preventDefault(); // Prevent default link behavior
        if (addressForm.style.display === 'none') {
            addressForm.style.display = 'block'; // Display the form
        } else {
            addressForm.style.display = 'none'; // Hide the form
        }
    });
</script>

    <script>
        async function updateQuantity(productId, action) {
            try {
                const response = await fetch(`/update-quantity/${productId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: action })
                });

                if (response.ok) {
                    // Quantity updated successfully
                    const data = await response.json();
                    console.log(data);
                    // Update the quantity display
                    document.getElementById(`quantity-${productId}`).innerText = data.currentCartitem.quantity;
                    // Update the subtotal display
                    document.getElementById(`subtotal-${productId}`).innerText = "₹" + data.currentCartitem.subtotal;
                    // // Update the total display
                    document.getElementById('checkout-subtotal').innerText = "₹" + data.Total;
                    // // Update the total display
                    document.getElementById('checkout-total').innerText = "₹" + data.Total;
                } else {
                    // Handle error
                    console.error('Failed to update quantity');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
    </script>

<script>
    let selectedAddressId;

    function addressHandle() {
        // Find the selected address ID
        selectedAddressId = document.querySelector('input[name="deliveryAddress"]:checked').value;
    }

    async function placeOrder(cartId) {
        try {
            // Find the selected payment option ID
            let selectedPaymentOption = document.querySelector('input[name="payment_option"]:checked').id;
            
            // Make the fetch request to place the order
            const response = await fetch('/placeorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cartId: cartId, addressId: selectedAddressId, paymentOption: selectedPaymentOption })
            });

            if (response.ok) {
                // Order placed successfully, redirect to order page
                window.location.href = "/orderpage";
            } else {
                // Handle error
                console.error('Failed to place order');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
</script>


    <%- include('../layouts/userFooter.ejs') %>